#! /usr/bin/env python

# Weather information
# Made by phrakture (http://phraktured.net/config/screen/batinfo)
# Modified by Wael Nasreddine

import urllib
import xml.parsers.expat

class WeatherParser:
    def __init__(self,citycode,metric):
        self.dict={}
        self.curtag=''
        try:
            p = xml.parsers.expat.ParserCreate()
            p.StartElementHandler = self._starttag
            p.EndElementHandler = self._endtag
            p.CharacterDataHandler = self._handledata

            urlstr = 'http://xoap.weather.com/weather/local/' + citycode + '?cc&unit='
            if metric :
                urlstr += 'm'
            else :
                urlstr += 's'

            url=urllib.urlopen(urlstr)
            p.ParseFile(url)
            url.close()
        except:
            pass

    def _starttag(self,name,attrs):
        name=name.encode('ascii','replace')
        self.curtag = name

    def _endtag(self,name):
        pass

    def _handledata(self,data):
        data=data.encode('ascii','replace').strip()
        if len(data)>0:
            self.dict[self.curtag] = data

def color(txt,c):
    return '{k' + c + '}' + str(txt)

wth = WeatherParser('95123',True)

t = int(wth.dict['tmp'])
temp = ''
if t < 0:
    temp = color(t,'b')+wth.dict['ut']
elif t <= 32:
    temp = color(t,'c')+wth.dict['ut']
elif t <= 80:
    temp = color(t,'w')+wth.dict['ut']
elif t <= 100:
    temp = color(t,'y')+wth.dict['ut']
else:
    temp = color(t,'r')+wth.dict['ut']

w = int(wth.dict['s'])
wind = ''
if w == 0:
    wind = color(w,'w')+wth.dict['us']
elif w <= 10:
    wind = color(w,'c')+wth.dict['us']
elif w <= 20:
    wind = color(w,'g')+wth.dict['us']
elif w <= 30:
    wind = color(w,'y')+wth.dict['us']
else:
    wind = color(w,'r')+wth.dict['us']

name=color(wth.dict['dnam'],'y')

print name + '{kw}: ' + temp + '{kw}, wind ' + wind + '{-}'
